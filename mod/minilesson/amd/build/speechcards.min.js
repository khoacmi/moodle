define ("mod_minilesson/speechcards",["jquery","jqueryui","core/log","core/ajax","mod_minilesson/definitions","mod_minilesson/pollyhelper","mod_minilesson/cloudpoodllloader","mod_minilesson/ttrecorder"],function(a,b,c,d,e,f,g,h){"use strict";c.debug("Poodll Time Speechcards: initialising");return{clone:function clone(){return a.extend(!0,{},this)},init:function init(a,b,c){this.init_app(a,b,c)},init_app:function init_app(b,e,f){console.log(e);var j={passmark:75,pointer:1,jsondata:null,props:null,dryRun:!1,language:"en-US",terms:[],displayterms:[],results:[],controls:{},init:function init(){for(var a=0;a<e.sentences.length;a++){j.terms[a]=e.sentences[a].sentence;j.displayterms[a]=e.sentences[a].displaysentence}c.debug("app terms",j.terms);j.language=e.language;this.init_controls();this.initComponents();this.register_events()},init_controls:function init_controls(){j.controls={};j.controls.star_rating=a("#"+e.uniqueid+"_container .minilesson_star_rating");j.controls.next_button=a("#"+e.uniqueid+"_container .minilesson-speechcards_nextbutton");j.controls.slider=a("#"+e.uniqueid+"_container .minilesson_speechcards_target_phrase")},next_question:function next_question(){var a={index:b,hasgrade:!0,totalitems:j.terms.length,correctitems:j.results.filter(function(a){return 0<a.points}).length};a.grade=Math.round(100*(a.correctitems/a.totalitems));f.do_next(a)},register_events:function register_events(){a("#"+e.uniqueid+"_container .minilesson_nextbutton").on("click",function(){j.next_question()});j.controls.next_button.click(function(){j.check(!1);if(j.is_end()){setTimeout(function(){j.do_end()},200)}else{setTimeout(function(){j.do_next()},200)}})},initComponents:function initComponents(){var b=function(b){switch(b.type){case"recording":break;case"speech":c.debug("speech at speechcards");var d=b.capturedspeech,e=j.cleanText(d),f=e,g=j.terms[j.pointer-1];c.debug("speechtext:",d);c.debug("spoken:",f);c.debug("correct:",g);var h=j.similarity(f,g);c.debug("JS similarity: "+f+":"+g+":"+h);if(h>=j.passmark||j.wordsDoMatch(e,j.terms[j.pointer-1])){c.debug("local match::"+f+":"+g);j.showStarRating(100);j.flagCorrectAndTransition();return}j.checkByPhonetic(f,g).then(function(b){if(!1===b){return a.Deferred().reject()}else{c.debug("PHP similarity: "+f+":"+g+":"+b);j.showStarRating(b);if(b>=j.passmark){j.flagCorrectAndTransition()}}});}};if(f.use_ttrecorder()){var d={uniqueid:e.uniqueid,callback:b};h.clone().init(d)}else{g.init("minilesson-recorder-speechcards-"+e.id,b)}j.progress_dots(j.results,j.terms);j.initSlider()},initSlider:function initSlider(){j.controls.slider.text(j.displayterms[j.pointer-1]);j.controls.slider.show()},writeCurrentTerm:function writeCurrentTerm(){j.controls.slider.toggle("slide",{direction:"left"});j.controls.slider.text(j.displayterms[j.pointer-1]);j.controls.slider.toggle("slide",{direction:"right"})},flagCorrectAndTransition:function flagCorrectAndTransition(){j.check(!0);if(j.is_end()){setTimeout(function(){j.do_end()},700)}else{setTimeout(function(){j.do_next()},700)}},wordsDoMatch:function wordsDoMatch(a,b){a=j.cleanText(a);b=j.cleanText(b);if(a==b){return!0}return!1},similarity:function similarity(a,b){var c=a,d=b;if(a.length<b.length){c=b;d=a}var e=c.length;if(0==e){return 1}return(e-j.editDistance(c,d))/parseFloat(e)},editDistance:function editDistance(a,b){a=a.toLowerCase();b=b.toLowerCase();for(var c=[],d=0,e;d<=a.length;d++){e=d;for(var f=0;f<=b.length;f++){if(0==d)c[f]=f;else{if(0<f){var g=c[f-1];if(a.charAt(d-1)!=b.charAt(f-1))g=Math.min(Math.min(g,e),c[f])+1;c[f-1]=e;e=g}}}if(0<d)c[b.length]=e}return c[b.length]},cleanText:function cleanText(a){var b=a.toLowerCase(),c=b.replace(/['!"#$%&\\'()\*+,\-\.\/:;<=>?@\[\\\]\^_`{|}~']/g,""),d=c.replace(/\s+/g," ").trim();return d},checkByPhonetic:function checkByPhonetic(a,b){return d.call([{methodname:"mod_minilesson_check_by_phonetic",args:{spoken:a,correct:b,language:j.language}}])[0]},showStarRating:function showStarRating(a){var b=[!0,!0,!0];if(1>a){b=[!0,!0,!1]}if(a<j.passmark){b=[!0,!1,!1]}if(.5>a){b=[!1,!1,!1]}var c="";b.forEach(function(a){if(!0===a){c+="<i class=\"fa fa-star\"></i>"}else{c+="<i class=\"fa fa-star-o\"></i>"}});j.controls.star_rating.html(c)},check:function check(a){var b=1;if(!0==a){b=1}else{b=0}var c={points:b};j.results.push(c)},do_next:function do_next(){j.pointer++;j.progress_dots(j.results,j.terms);j.clearStarRating();if(!j.is_end()){j.writeCurrentTerm()}else{j.do_end()}},clearStarRating:function clearStarRating(){j.controls.star_rating.html("\xB7 \xB7 \xB7")},do_end:function do_end(){j.next_question()},is_end:function is_end(){if(j.pointer<=j.terms.length){return!1}else{return!0}},progress_dots:function progress_dots(b,c){var d="",f="";c.forEach(function(a,c){f="darkgray";if(b[c]!==void 0){if(b[c].points){f="green"}else{f="red"}}d+="<i style=\"color:"+f+";\" class=\"fa fa-circle\"></i>"});a("#"+e.uniqueid+"_container .minilesson_progress_dots").html(d)}};j.init()}}});
//# sourceMappingURL=speechcards.min.js.map
